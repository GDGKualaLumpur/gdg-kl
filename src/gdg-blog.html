<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/marked-element/marked-element.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="shared-app-style.html">
<dom-module id="gdg-blog">
    <template>
        <style include="shared-app-style">
        :host {
            display: block;
            background-color: #eee;
        }
        
        .blog {
            padding: 48px 0;
            margin: 0px auto;
            max-width: 900px;
        }
        
        .blog .content {
            padding: 24px 36px;
            border-radius: 2px;
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
            background-color: white;
        }
        
        .markdown-html p {
            line-height: 2em;
            font-weight: 300;
        }
        
        .markdown-html {
            line-height: 2em;
            font-weight: 300;
        }
        
        .markdown-html pre {
            padding: .5em;
            overflow-x: auto;
            background: white;
            font-weight: 400;
        }
        
        @media screen and (max-width:840px) {
            section {
                padding: 40px 24px;
            }
            .blog {
                padding: 20px;
            }
            .blog .content {
                padding: 24px;
            }
            .markdown-html p {
                line-height: 1.8em;
            }
            .markdown-html img {
                width: 95%;
                height: auto;
            }
        }
        </style>
        <iron-ajax id="ajax" auto handle-as="json" on-response="ajaxResponse" loading="{{isLoading}}"></iron-ajax>
        <app-indexeddb-mirror key="{{indexeddbkey}}" data="{{blogData}}" persisted-data="{{persistedData}}">
        <app-indexeddb-mirror key="{{indexeddbkey}}" data="{{blogPost}}" persisted-data="{{persistedPost}}">
        <template is="dom-if" if="{{!showPost}}">
            <section class="header">
                <div class="container">
                    <h2>{{localize('blog')}}</h2>
                    <p>{{localize('blogdesc')}}</p>
                </div>
            </section>
            <section class="blog">
                <template is="dom-repeat" items="{{persistedData}}" id="list">
                    <a href="/blog/[[dashcase(item.title)]]" class="article">
                        <h4>[[item.title]]</h4>
                        <div class="detail">
                            <span>
                                <img src="/images/gdg.png">
                                <p>{{localize('publishedby')}} [[item.author.displayName]]</p>
                            </span>
                            <span>
                                <iron-icon icon="cal" class="cal"></iron-icon>
                                <p>{{localize('postedon')}} [[timestamp(item.published)]]</p>
                            </span>
                        </div>
                    </a>
                </template>
                <div class="overlay" hidden$="[[!isLoading]]">
                    <paper-spinner active="[[isLoading]]"></paper-spinner>
                </div>
            </section>
        </template>
        <template is="dom-if" if="{{showPost}}">
            <section class="header">
                <div class="container">
                    <h2>[[persistedPost.title]]</h2>
                    <p>[[timestamp(persistedPost.published, persistedPost.author.displayName)]]</p>
                </div>
            </section>
            <section class="blog">
                <div class="content" hidden$="[[isLoading]]">
                    <marked-element markdown="[[persistedPost.content]]">
                        <div class="markdown-html"></div>
                    </marked-element>
                </div>
                <div class="overlay" hidden$="[[!isLoading]]">
                    <paper-spinner active="[[isLoading]]"></paper-spinner>
                </div>
            </section>
        </template>
    </template>
    <script>
    Polymer({
        is: 'gdg-blog',

        behaviors: [
            Polymer.AppLocalizeBehavior
        ],

        properties: {
            showPost: {
                type: Boolean
            },
            postid: {
                type: String,
                notify: true,
                observer: '_postIdChanged'
            },
            persistedData: {
                type: Array,
                notify: true,

            },
            nextPageToken: {
                type: String
            },
            apiKey: {
                type: String,
                value: "AIzaSyDvmMxa5XU5VomJIE0Au-lgYt6QQuZ3Mwc"
            },
            language: {
                type: String,
            },
            indexeddbkey: {
                type: String,
                notify: true
            }
        },

        _postIdChanged: function() {
            this.post = [];
            if (this.postid) {
                this.indexeddbkey = "blog/" + this.postid;
                this.$.ajax.url = "https://www.googleapis.com/blogger/v3/blogs/3213900/posts/search";
                this.$.ajax.params = {
                    "key": this.apiKey,
                    "q": this.postid
                };
                this.showPost = true;

            } else {
                this.indexeddbkey = "blog";
                this.blogData = [];
                this.$.ajax.url = "https://www.googleapis.com/blogger/v2/blogs/3213900/posts";
                this.$.ajax.params = {
                    "key": this.apiKey
                };
                this.showPost = false;
            }
        },

        ready: function() {
            this._postIdChanged();
        },

        attached: function() {
            this.loadResources(this.resolveUrl('/data/locales.json'));
        },

        dashcase: function(text) {
            return text.replace(/\s+/g, '-').toLowerCase();
        },

        timestamp: function(unix_timestamp, displayName) {
            if (unix_timestamp) {
                MyDate = new Date(unix_timestamp);
                var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                if (this.postid) {
                    return 'Posted ' + ('0' + MyDate.getDate()).slice(-2) + ' ' + monthNames[MyDate.getMonth()] + ' ' + MyDate.getFullYear() + '  by ' + displayName;
                } else {
                    return ('0' + MyDate.getDate()).slice(-2) + ' ' + monthNames[MyDate.getMonth()] + ' ' + MyDate.getFullYear()
                }

            }

        },

        ajaxResponse: function(event) {
            var response = event.detail.response;
            if (this.postid) {
                if (response.items != undefined) {
                    this.blogPost = response.items[0];
                    document.title = response.items[0].title.charAt(0).toUpperCase() + response.items[0].title.slice(1) + " - GDGKL";
                }
            } else {
                if (this.list && this.nextPageToken) {
                    for (var i = 0; i < response.items.length; i++) {
                        this.push('blogData.list', response.items[i])
                    }
                } else {
                    this.blogData = response.items;
                }
                if (response.nextPageToken) {
                    this.nextPageToken = response.nextPageToken;
                    // this.nextpage();
                }
            }
        },

        nextpage: function() {
            this.$.ajax.params = {
                "key": "AIzaSyDvmMxa5XU5VomJIE0Au-lgYt6QQuZ3Mwc",
                "pageToken": this.nextPageToken
            }
        },
    });
    </script>
</dom-module>
