<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/marked-element/marked-element.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<dom-module id="gdg-blog">
    <template>
        <style>
        :host {
            display: block;
            background-color: #eee;
        }
        
        .header {
            padding: 40px 80px;
            background: var(--app-header-color);
            color: white;
        }
        
        .header .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .markdown-html p {
            line-height: 2em;
            font-weight: 300;
        }
        
        .markdown-html {
            line-height: 2em;
            font-weight: 300;
        }
        
        .markdown-html pre {
            padding: .5em;
            overflow-x: auto;
            background: white;
            font-weight: 400;
        }
        
        .blog {
            padding: 48px 0;
            margin: 0px auto;
            max-width: 900px;
        }
        
        .blog .content {
            padding: 24px 36px;
            border-radius: 2px;
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
            background-color: white;
        }
        
        .article {
            display: block;
            border-radius: 2px;
            border-bottom: 1px solid #E0E0E0;
            padding: 24px 36px;
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
            background: white;
            text-decoration: none;
        }
        
        .article h3 {
            margin: 0;
            color: #000;
            font-weight: 400;
            font-size: 20px;
        }
        
        .article a {
            font-weight: 400;
            font-size: 20px;
            text-decoration: none;
        }
        
        .article .detail span {
            display: block;
            margin-top: 8px;
        }
        
        .article .detail {
            margin-top: 16px;
            display: block;
        }
        
        .article .detail img {
            height: 25px;
            vertical-align: middle;
        }
        
        .article .detail p {
            color: #212121;
            display: inline;
            font-size: 16px;
            font-weight: 300;
            margin-left: 4px;
        }
        
        .article .detail .publisher {
            color: #006064;
            font-weight: 400;
        }
        
        .article .detail .cal {
            color: #F44336;
        }
        
        .overlay {
            margin: 96px 0;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .overlay[hidden] {
            display: none;
        }
        
        @media screen and (max-width:840px) {
            .header {
                padding: 40px 20px;
            }
            section {
                padding: 40px 24px;
            }
            .blog {
                padding: 20px;
            }
            .blog .content {
                padding: 24px;
            }
            .article {
                padding: 18px 24px;
            }
            .article a {
                font-size: 20px;
            }
            .article h3 {
                font-size: 18px;
            }
            .article .detail {
                margin-top: 8px;
            }
            .markdown-html p {
                line-height: 1.8em;
            }
            .markdown-html img {
                width: 95%;
                height: auto;
            }
        }
        </style>
        <iron-ajax id="ajax" auto handle-as="json" on-response="ajaxResponse" loading="{{isLoading}}"></iron-ajax>
        <template is="dom-if" if="{{!showPost}}">
            <section class="header">
                <div class="container">
                    <h2>Blog</h2>
                    <p>Official blog of Google Developer Group (GDG) Kuala Lumpur</p>
                </div>
            </section>
            <section class="blog">
                <template is="dom-repeat" items="{{list}}" id="list">
                    <a href="/blog/[[dashcase(item.title)]]" class="article">
                        <h3>[[item.title]]</h3>
                        <div class="detail">
                            <span>
                                <img src="/images/gdg.png">
                                <p>Published by [[item.author.displayName]]</p>
                            </span>
                            <span>
                                <iron-icon icon="cal" class="cal"></iron-icon>
                                <p>Posted on [[timestamp(item.published)]]</p>
                            </span>
                        </div>
                    </a>
                </template>
                <div class="overlay" hidden$="[[!isLoading]]">
                    <paper-spinner active="[[isLoading]]"></paper-spinner>
                </div>
            </section>
        </template>
        <template is="dom-if" if="{{showPost}}">
            <section class="header">
                <div class="container">
                    <h2>[[post.title]]</h2>
                    <p>[[timestamp(post.published, post.author.displayName)]]</p>
                </div>
            </section>
            <section class="blog">
                <div class="content" hidden$="[[isLoading]]">
                    <marked-element markdown="[[post.content]]">
                        <div class="markdown-html"></div>
                    </marked-element>
                </div>
                <div class="overlay" hidden$="[[!isLoading]]">
                    <paper-spinner active="[[isLoading]]"></paper-spinner>
                </div>
            </section>
        </template>
    </template>
    <script>
    Polymer({
        is: 'gdg-blog',

        properties: {
            showPost: {
                type: Boolean
            },
            postid: {
                type: String,
                notify: true,
                observer: '_postIdChanged'
            },
            list: {
                type: Array,
                notify: true,

            },
            nextPageToken: {
                type: String
            },
            apiKey: {
                type: String,
                value: "AIzaSyDvmMxa5XU5VomJIE0Au-lgYt6QQuZ3Mwc"
            }

        },

        _postIdChanged: function() {
            this.post = [];
            if (this.postid) {
                this.$.ajax.url = "https://www.googleapis.com/blogger/v3/blogs/3213900/posts/search";
                this.$.ajax.params = {
                    "key": this.apiKey,
                    "q": this.postid
                };
                this.showPost = true;

            } else {
                this.list = [];
                this.$.ajax.url = "https://www.googleapis.com/blogger/v2/blogs/3213900/posts";
                this.$.ajax.params = {
                    "key": this.apiKey
                };
                this.showPost = false;
            }
        },

        ready: function() {
            this._postIdChanged();
        },

        dashcase: function(text) {
            return text.replace(/\s+/g, '-').toLowerCase();
        },

        timestamp: function(unix_timestamp, displayName) {
            if (unix_timestamp) {
                MyDate = new Date(unix_timestamp);
                var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                if (this.postid) {
                    return 'Posted ' + ('0' + MyDate.getDate()).slice(-2) + ' ' + monthNames[MyDate.getMonth()] + ' ' + MyDate.getFullYear() + '  by ' + displayName;
                } else {
                    return ('0' + MyDate.getDate()).slice(-2) + ' ' + monthNames[MyDate.getMonth()] + ' ' + MyDate.getFullYear()
                }

            }

        },

        ajaxResponse: function(event) {
            var response = event.detail.response;
            if (this.postid) {
                if (response.items != undefined) {
                    console.log(response.items[0].author.displayName)
                    this.post = response.items[0];
                    document.title = response.items[0].title.charAt(0).toUpperCase() + response.items[0].title.slice(1) + " - GDGKL";
                }
            } else {
                if (this.list && this.nextPageToken) {
                    for (var i = 0; i < response.items.length; i++) {
                        this.push('list', response.items[i])
                    }
                } else {
                    this.list = response.items;
                }
                if (response.nextPageToken) {
                    this.nextPageToken = response.nextPageToken;
                    // this.nextpage();
                }
            }
        },

        nextpage: function() {
            this.$.ajax.params = {
                "key": "AIzaSyDvmMxa5XU5VomJIE0Au-lgYt6QQuZ3Mwc",
                "pageToken": this.nextPageToken
            }
        },
    });
    </script>
</dom-module>
