<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/marked-element/marked-element.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="shared-app-style.html">
<dom-module id="gdg-event">
    <template>
        <style include="shared-app-style">
        :host {
            display: block;
        }
        
        .event {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .event h3 {
            margin: 40px 12px 16px 12px;
            font-weight: 400;
        }
        
        @media screen and (max-width:840px) {
            .event h3 {
                margin: 16px 12px
            }
        }
        </style>
        <iron-ajax auto url="https://gdg-kl.firebaseio.com/data.json" handle-as="json" on-response="_eventData" loading="{{isLoading}}"></iron-ajax>
        <app-indexeddb-mirror key="events" data="{{eventData}}" persisted-data="{{persistedData}}">
        </app-indexeddb-mirror>
        <section class="header">
            <div class="container">
                <h2>{{localize('event')}}</h2>
                <p>{{localize('eventdesc')}}</p>
            </div>
        </section>
        <section class="event">
            <div class="overlay" hidden$="[[!isLoading]]">
                <paper-spinner active="[[isLoading]]"></paper-spinner>
            </div>
            <template is="dom-if" if="{{upcomingDom}}">
                <div class="upcoming">
                    <h3>Upcoming Event</h3>
                    <template is="dom-repeat" items="{{persistedData.future}}">
                        <a href="https://developers.google.com[[item.link]]" target="_blank" class="article">
                            <h4>[[item.title]]</h4>
                            <div class="detail">
                                <span>
                                    <iron-icon icon="cal" class="cal"></iron-icon>
                                    <p>[[timestamp(item.start)]]</p>
                                </span>
                                <span>
                                    <iron-icon icon="location" class="location"></iron-icon>
                                    <p>[[item.location]]</p>
                                </span>
                            </div>
                        </a>
                    </template>
                </div>
            </template>
            <template is="dom-if" if="{{pastDom}}">
                <div class="past">
                    <h3>Past Event</h3>
                    <template is="dom-repeat" items="{{persistedData.past}}">
                        <a href="https://developers.google.com[[item.link]]" class="article">
                            <h4>[[item.title]]</h4>
                            <div class="detail">
                                <span>
                                    <iron-icon icon="cal" class="cal"></iron-icon>
                                    <p>[[timestamp(item.start)]]</p>
                                </span>
                                <span>
                                    <iron-icon icon="location" class="location"></iron-icon>
                                    <p>[[item.location]]</p>
                                </span>
                            </div>
                        </a>
                    </template>
                </div>
            </template>
        </section>
    </template>
    <script>
    Polymer({
        is: 'gdg-event',

        behaviors: [
            Polymer.AppLocalizeBehavior
        ],


        properties: {
            eventData: {
                type: Array,
                notify: true,
            },
            persistedData: {
                type: Array,
                notify: true,
                value: []
            },
            upcomingDom: {
                type: Boolean,
                value: false
            },
            pastDom: {
                type: Boolean,
                value: false
            },
            language: {
                type: String,
            }
        },

        _eventData: function(event) {
            data = event.detail.response;
            data.past = data.past.reverse();
            this.eventData = data;
            if (this.eventData.future.length){
                this.upcomingDom = true;
            }
            if (this.eventData.past.length){
                this.pastDom = true;
            }
        },

        timestamp: function(unix_timestamp){
            MyDate = new Date(unix_timestamp);
            var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            return ('0' + MyDate.getDate()).slice(-2) + ' ' + monthNames[MyDate.getMonth()] + ' ' + MyDate.getFullYear();
        },

        attached: function() {
            this.loadResources(this.resolveUrl('/data/locales.json'));
        },
    });
    </script>
</dom-module>
