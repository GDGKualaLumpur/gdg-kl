<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">
<link rel="lazy-import" href="gdg-events-home.html">
<link rel="lazy-import" href="gdg-events-details.html">

<dom-module id="gdg-events">
  <template>
    <style include="shared-styles">
      :host {
        min-height: calc(100vh - 120px);
        display: block;
        background: #fafafa;
        border-bottom: 1px solid #cfcfcf;
      }
    </style>

    <paper-toast id="toast" duration="3000"></paper-toast>

    <app-route route="{{route}}" pattern="/events/:page" data="{{routeData}}" tail="{{subroute}}"></app-route>

    <iron-pages selected="[[page]]" attr-for-selected="name" fallback-selection="home">
      <gdg-events-home name="home" id="home"></gdg-events-home>
      <gdg-events-details name="details" id="details"></gdg-events-details>
    </iron-pages>

  </template>

  <script>
    class GdgEvents extends Polymer.LegacyElementMixin(Polymer.Element) {
      static get is() { return 'gdg-events'; }

      static get observers() {
        return [
          '_routePageChanged(routeData.page)'
        ];
      }
      static get properties() {
        return {
          page: {
            type: String,
            reflectToAttribute: true,
            observer: '_pageChanged',
          }
        };
      }

      _routePageChanged(page) {
        if (page === undefined || page.length <= 0) {
          this.page = 'home';
          document.title = 'Events - GDG Kuala Lumpur';
        }
        else {
          this.page = 'details'
        }
      }

      _loadEventComponents(page, oldPage) {
        var resolvedPageUrl = this.resolveUrl('gdg-events-' + page + '.html');
        Polymer.importHref(
          resolvedPageUrl,
          () => {
            this.$[page].loadData(this.routeData.page);
            this.shadowRoot.querySelector('gdg-events-details').addEventListener('showToast', e => {
              this.$.toast.open();
              this.$.toast.text = e.detail.text;
            })
          },
          function (error) { console.log(error) },
          true);
      }

      showToast() {
        console.log('?')
      }

      _pageChanged(page, oldPage) {
        if (!this.firestore_persistence) {
          this.firestore_persistence = firebase.firestore().enablePersistence()
            .then(() => {
              this._loadEventComponents(page, oldPage);
            })
            .catch((err) => {
              if (err.code == 'failed-precondition') {
                this._loadEventComponents(page, oldPage);
              } else if (err.code == 'unimplemented') {
                this._loadEventComponents(page, oldPage);
              }
            });
        }
        else {
          this._loadEventComponents(page, oldPage);
        }
      }
    }

    window.customElements.define(GdgEvents.is, GdgEvents);
  </script>
</dom-module>